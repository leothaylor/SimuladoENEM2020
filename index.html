<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador ENEM PRO</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script src="linguagens.js"></script>
  <script src="humanas.js"></script>
  <script src="natureza.js"></script>
  <script src="matematica.js"></script>

  <style>
    /* TEMA DIURNO (Papel / Prova Real) */
    :root {
      --bg-body: #f1f3f5;
      --bg-card: #ffffff;
      --border: #dee2e6;
      --border-focus: #adb5bd;
      --txt-main: #212529;
      --txt-muted: #495057;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --good: #16a34a;
      --bad: #dc2626;
      --review: #f59e0b;
      --radius: 12px;
      --shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: 'Inter', sans-serif; color: var(--txt-main); background: var(--bg-body); }

    /* TELAS */
    .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
    .screen.active { display: flex; }

    /* SCROLLBAR GERAL */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #ced4da; border-radius: 4px; }

    /* TELA INICIAL (Sagu√£o) */
    .home-container { text-align: center; max-width: 600px; margin: auto; background: var(--bg-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); }
    .home-container h1 { font-size: 28px; font-weight: 800; margin-bottom: 10px; color: var(--txt-main); }
    .home-container p { color: var(--txt-muted); margin-bottom: 30px; line-height: 1.5; }
    .home-btn { display: block; width: 100%; padding: 18px; margin-bottom: 15px; background: #f8f9fa; border: 2px solid var(--border); border-radius: var(--radius); font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; color: var(--txt-main); }
    .home-btn:hover { border-color: var(--accent); background: #eff6ff; }
    .home-btn.d1 { border-left: 6px solid var(--accent); }
    .home-btn.d2 { border-left: 6px solid var(--good); }

    /* TELA DA PROVA */
    .exam-header { width: min(1100px, 100%); display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); padding: 16px 20px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
    .timer-display { font-size: 22px; font-weight: 800; font-family: monospace; color: var(--txt-main); display: flex; align-items: center; gap: 8px; }
    .timer-display.low { color: var(--bad); animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }
    
    .btn-small { background: #f8f9fa; border: 1px solid var(--border); padding: 8px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; color: var(--txt-main); }
    .btn-small:hover { background: #e9ecef; }
    .btn-danger { background: #fee2e2; border-color: #f87171; color: var(--bad); }
    .btn-danger:hover { background: #fecaca; }

    .exam-layout { width: min(1100px, 100%); display: grid; grid-template-columns: 1fr 300px; gap: 16px; flex: 1; min-height: 0; padding-bottom: 80px; }

    /* CARD DA QUEST√ÉO */
    .question-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; box-shadow: var(--shadow); overflow: hidden; }
    .q-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; font-weight: 700; color: var(--txt-muted); background: #f8f9fa; }
    .q-body { padding: 24px 20px; overflow-y: auto; flex: 1; font-size: 16px; line-height: 1.6; }
    
    #qImage { max-width: 100%; max-height: 350px; border-radius: 8px; margin-bottom: 20px; display: none; object-fit: contain; border: 1px solid var(--border); }
    
    .q-text { margin-bottom: 24px; white-space: pre-wrap; }
    
    .alts { display: flex; flex-direction: column; gap: 10px; }
    .alt { display: flex; gap: 12px; padding: 14px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: 0.1s; background: #fff; align-items: flex-start; }
    .alt:hover { border-color: var(--border-focus); background: #f8f9fa; }
    .alt.selected { border-color: var(--accent); background: #eff6ff; }
    .alt .key { font-weight: 800; color: var(--txt-muted); min-width: 24px; }
    .alt.selected .key { color: var(--accent); }

    .q-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; background: #f8f9fa; gap: 10px; }
    .btn-nav { flex: 1; padding: 12px; border: 1px solid var(--border); background: #fff; border-radius: 8px; font-weight: 700; cursor: pointer; color: var(--txt-main); transition: 0.1s; }
    .btn-nav:hover { background: #e9ecef; }
    .btn-nav.review { border-color: #fcd34d; background: #fffbeb; color: #b45309; }
    .btn-nav.review.active { background: var(--review); color: #fff; border-color: var(--review); }

    /* GRID LATERAL (MAPA DA PROVA) - Padr√£o Desktop */
    .grid-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; display: flex; flex-direction: column; box-shadow: var(--shadow); max-height: 100%; overflow-y: auto; }
    .grid-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--txt-muted); text-align: center; }
    .grid-boxes { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
    .g-box { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--txt-muted); background: #fff; }
    .g-box:hover { border-color: var(--border-focus); }
    .g-box.answered { background: #e9ecef; color: var(--txt-main); border-color: #ced4da; }
    .g-box.current { border: 2px solid var(--accent); font-weight: 800; color: var(--accent); }
    .g-box.review { border: 2px solid var(--review); background: #fef3c7; color: #b45309; }
    
    .g-box-redacao { grid-column: span 5; aspect-ratio: auto; padding: 10px; background: #f8f9fa; border: 2px dashed #ced4da; }
    .g-box-redacao.answered { background: #dcfce7; border-color: var(--good); color: #166534; border-style: solid; }

    /* ==========================================================
       ADAPTA√á√ÉO EXCLUSIVA PARA CELULAR (iPhone / Smartphones)
       ========================================================== */
    @media (max-width: 800px) { 
      .exam-layout { 
        display: flex; 
        flex-direction: column; 
        gap: 12px;
      }
      .grid-panel { 
        padding: 12px 16px; 
        max-height: unset; /* Permite que seja fininho */
      } 
      .grid-title { 
        text-align: left; 
        margin-bottom: 8px; 
        font-size: 13px; 
      }
      .grid-boxes { 
        display: flex; /* Muda de grade quadrada para linha reta */
        flex-wrap: nowrap; 
        overflow-x: auto; /* Habilita rolagem lateral */
        gap: 10px; 
        padding-bottom: 8px; /* Espa√ßo para n√£o cortar a bordinha */
      }
      .grid-boxes::-webkit-scrollbar { height: 4px; } /* Deixa a barra fininha */
      .g-box { 
        flex: 0 0 45px; /* Trava o tamanho do bot√£o */
        height: 45px; 
        aspect-ratio: auto; 
        font-size: 14px;
      }
      .g-box-redacao { 
        flex: 0 0 130px; /* Alarga o bot√£o da reda√ß√£o na linha */
      }
      .q-footer {
        flex-wrap: wrap; /* Em celulares muito finos os bot√µes podem se ajustar */
      }
    }

    /* TELA DE RELAT√ìRIO */
    .report-container { width: min(800px, 100%); background: var(--bg-card); padding: 30px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); margin: auto; }
    .r-header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
    .r-header h2 { font-size: 24px; color: var(--txt-main); margin-bottom: 5px; }
    .r-header p { color: var(--txt-muted); font-size: 14px; }
    
    .r-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
    .stat-box { padding: 20px; border-radius: 10px; text-align: center; border: 1px solid var(--border); }
    .stat-box.green { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
    .stat-box.red { background: #fef2f2; border-color: #fecaca; color: #991b1b; }
    .stat-box.blue { background: #eff6ff; border-color: #bfdbfe; color: #1e3a8a; }
    .stat-box .lbl { font-size: 13px; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; opacity: 0.8; }
    .stat-box .val { font-size: 32px; font-weight: 800; }

    .r-redacao { padding: 16px; background: #f8f9fa; border: 1px solid var(--border); border-radius: 10px; text-align: center; margin-bottom: 30px; font-weight: 600; }
    .r-redacao.feito { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
    
    .r-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 6px; margin-bottom: 30px; }
    @media (max-width: 600px) { .r-grid { grid-template-columns: repeat(5, 1fr); } }
    .rg-box { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; border-radius: 4px; color: #fff; }
    .rg-box.hit { background: var(--good); }
    .rg-box.miss { background: var(--bad); }
    .rg-box.blank { background: #e9ecef; color: var(--txt-muted); border: 1px solid #ced4da; }

    .r-details { margin-top: 30px; text-align: left; }
    .r-detail-item { padding: 16px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; font-size: 14px; background: #fff; }
    .r-detail-item.miss { background: #fef2f2; border-left: 5px solid var(--bad); }
    .r-detail-item.blank { background: #f8f9fa; border-left: 5px solid var(--txt-muted); }
    .r-detail-title { font-weight: 800; margin-bottom: 8px; color: var(--txt-main); display: flex; justify-content: space-between;}
    .r-detail-ans { color: var(--txt-muted); font-size: 15px; }
    .r-detail-ans b { color: var(--txt-main); }
    .r-detail-ans b.correct { color: var(--good); }
    .r-detail-ans b.wrong { color: var(--bad); }

    .btn-export { display: block; width: 100%; padding: 16px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; text-align: center; margin-top: 20px;}
    .btn-export:hover { background: var(--accent-hover); }

    /* Modal Mobile */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 99999; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; display: none; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-body); border-radius: var(--radius); width: 100%; max-width: 600px; padding: 20px; text-align: center; }
    .modal-content img { max-width: 100%; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border); }
    #exportTarget { position: absolute; top: 0; left: -9999px; z-index: -1; }
  </style>
</head>
<body>

  <div id="screenHome" class="screen active">
    <div class="home-container">
      <h1>üß† Simulador ENEM PRO</h1>
      <p>Treine resist√™ncia, gest√£o de tempo e simule o ambiente real de prova. Sem pausas obrigat√≥rias, sem feedback imediato.</p>
      
      <button class="home-btn d1" onclick="startExam('D1')">
        Iniciar Dia 1 (5h30m)<br>
        <span style="font-size: 13px; font-weight: 500; color: var(--txt-muted);">Linguagens, Humanas e Reda√ß√£o</span>
      </button>

      <button class="home-btn d2" onclick="startExam('D2')">
        Iniciar Dia 2 (5h00m)<br>
        <span style="font-size: 13px; font-weight: 500; color: var(--txt-muted);">Matem√°tica e Natureza</span>
      </button>
    </div>
  </div>

  <div id="screenExam" class="screen">
    <div class="exam-header">
      <div class="timer-display" id="timerDisplay">‚è±Ô∏è 00:00:00</div>
      <div style="display: flex; gap: 10px;">
        <button class="btn-small" id="btnPause" onclick="togglePause()">Pausar</button>
        <button class="btn-small btn-danger" onclick="finishExam()">Entregar Prova</button>
      </div>
    </div>

    <div class="exam-layout">
      <div class="question-panel">
        <div class="q-header">
          <span id="qIdDisplay">Quest√£o 1</span>
          <span id="qMateriaDisplay">M√≥dulo</span>
        </div>
        <div class="q-body">
          <img id="qImage" src="" alt="Imagem da quest√£o" />
          <div class="q-text" id="qText">Carregando...</div>
          <div class="alts" id="qAlts"></div>
        </div>
        <div class="q-footer">
          <button class="btn-nav" onclick="nav(-1)">‚óÑ Anterior</button>
          <button class="btn-nav review" id="btnMarkReview" onclick="toggleReview()">üö© Marcar Revis√£o</button>
          <button class="btn-nav" onclick="nav(1)">Pr√≥ximo ‚ñ∫</button>
        </div>
      </div>

      <div class="grid-panel">
        <div class="grid-title">Mapa da Prova</div>
        <div class="grid-boxes" id="gridMap"></div>
      </div>
    </div>
  </div>

  <div id="screenReport" class="screen">
    <div class="report-container" id="reportNode">
      <div class="r-header">
        <h2>Boletim de Desempenho</h2>
        <p id="rSubtitle">Calculando resultados...</p>
      </div>

      <div class="r-stats">
        <div class="stat-box green"><div class="lbl">Acertos</div><div class="val" id="rHits">0</div></div>
        <div class="stat-box red"><div class="lbl">Erros</div><div class="val" id="rMisses">0</div></div>
        <div class="stat-box blue"><div class="lbl">Precis√£o</div><div class="val" id="rAcc">0%</div></div>
      </div>

      <div id="rRedacaoStatus" class="r-redacao" style="display: none;">
        Reda√ß√£o: N√£o realizada
      </div>

      <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--txt-muted); text-align: center;">Gabarito Geral</h3>
      <div class="r-grid" id="rGrid"></div>

      <div id="rDetails" class="r-details"></div>

      <button class="btn-export" onclick="exportReport()" data-html2canvas-ignore>‚¨áÔ∏è Baixar Imagem do Boletim</button>
      <button class="btn-small" style="width: 100%; margin-top: 10px; padding: 12px;" onclick="location.reload()" data-html2canvas-ignore>Voltar ao In√≠cio</button>
    </div>
  </div>

  <div id="exportModal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-bottom: 10px; color: var(--txt-main);">Boletim Gerado!</h3>
      <p style="font-size: 14px; color: var(--txt-muted); margin-bottom: 20px;">Pressione e segure a imagem abaixo para <b>Salvar</b>.</p>
      <img id="exportedImage" src="" alt="Relat√≥rio" />
      <button class="btn-export" onclick="document.getElementById('exportModal').classList.remove('active')">Fechar</button>
    </div>
  </div>

  <div id="exportTarget"></div>

  <script>
    /* =========================================================
       MOTOR DE MONTAGEM DE DADOS
       Ele pega as vari√°veis dos 4 arquivos e junta tudo!
       ========================================================= */
    const DB = {
      D1: [],
      D2: []
    };

    if (typeof window.DB_LINGUAGENS !== 'undefined') DB.D1.push(...window.DB_LINGUAGENS);
    if (typeof window.DB_HUMANAS !== 'undefined') DB.D1.push(...window.DB_HUMANAS);
    
    // Insere a Reda√ß√£o
    DB.D1.push({ 
      id: "RED-91", mat: "Reda√ß√£o Oficial (ENEM 2020)", type: "essay", 
      text: "A partir da leitura dos textos motivadores e com base nos conhecimentos constru√≠dos ao longo de sua forma√ß√£o, redija um texto dissertativo-argumentativo em modalidade escrita formal da l√≠ngua portuguesa sobre o tema:\n\n\"O estigma associado √†s doen√ßas mentais na sociedade brasileira\"\n\n(Lembre-se: escreva sua reda√ß√£o √† m√£o em uma folha. Marque abaixo apenas se voc√™ a concluiu ou se pulou).", 
      alts: ["‚úÖ Feito (Escrevi a reda√ß√£o)", "‚ùå N√£o feito (Pulei a reda√ß√£o)"], answer: null 
    });

    if (typeof window.DB_NATUREZA !== 'undefined') DB.D2.push(...window.DB_NATUREZA);
    if (typeof window.DB_MATEMATICA !== 'undefined') DB.D2.push(...window.DB_MATEMATICA);

    /* =========================================================
       VARI√ÅVEIS DE ESTADO DO SIMULADO
       ========================================================= */
    let examData = []; 
    let currentExamType = ''; 
    let currentIdx = 0; 
    
    let userAnswers = {}; 
    let reviewMarks = new Set(); 
    
    let totalSeconds = 0;
    let elapsedSeconds = 0;
    let timerInterval = null;
    let isPaused = false;

    /* =========================================================
       FUN√á√ïES DE FLUXO (TELAS)
       ========================================================= */
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function startExam(type) {
      if (DB[type].length === 0 || (type === 'D1' && DB[type].length === 1)) {
        alert("O banco de dados para este dia ainda n√£o foi carregado. Verifique os arquivos .js");
        return;
      }

      currentExamType = type;
      examData = DB[type];
      
      totalSeconds = (type === 'D1') ? (5.5 * 3600) : (5 * 3600);
      elapsedSeconds = 0;
      isPaused = false;
      document.getElementById('btnPause').textContent = "Pausar";
      
      clearInterval(timerInterval);
      timerInterval = setInterval(tickTimer, 1000);
      updateTimerDisplay();

      userAnswers = {};
      reviewMarks.clear();
      currentIdx = 0;

      buildGrid();
      renderQuestion();
      showScreen('screenExam');
    }

    /* =========================================================
       TIMER
       ========================================================= */
    function tickTimer() {
      if(isPaused) return;
      if(totalSeconds > 0) {
        totalSeconds--;
        elapsedSeconds++;
        updateTimerDisplay();
      } else {
        clearInterval(timerInterval);
        alert("O TEMPO ESGOTOU! A prova ser√° entregue automaticamente.");
        finishExam(true);
      }
    }

    function updateTimerDisplay() {
      const display = document.getElementById('timerDisplay');
      let h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
      let m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
      let s = (totalSeconds % 60).toString().padStart(2, '0');
      display.textContent = `‚è±Ô∏è ${h}:${m}:${s}`;
      
      if(totalSeconds <= 1800) { display.classList.add('low'); } 
      else { display.classList.remove('low'); }
    }

    function togglePause() {
      isPaused = !isPaused;
      document.getElementById('btnPause').textContent = isPaused ? "‚ñ∂ Retomar" : "Pausar";
      document.getElementById('qAlts').style.opacity = isPaused ? "0.2" : "1";
      document.getElementById('qAlts').style.pointerEvents = isPaused ? "none" : "auto";
      
      const imgEl = document.getElementById('qImage');
      if(isPaused) {
        document.getElementById('qText').textContent = "PROVA PAUSADA";
        imgEl.style.display = "none";
      } else {
        renderQuestion(); 
      }
    }

    /* =========================================================
       RENDERIZA√á√ÉO DA QUEST√ÉO
       ========================================================= */
    function renderQuestion() {
      if(isPaused) return; 
      
      const q = examData[currentIdx];
      
      let qNumText = q.type === 'essay' ? `Reda√ß√£o` : `Quest√£o ${currentIdx + 1}`;
      document.getElementById('qIdDisplay').textContent = qNumText;
      document.getElementById('qMateriaDisplay').textContent = q.mat;
      document.getElementById('qText').textContent = q.text;

      // L√ìGICA DE CARREGAMENTO DA IMAGEM
      const imgEl = document.getElementById('qImage');
      if (q.img) {
        imgEl.src = "imagens/" + q.img;
        imgEl.style.display = "block";
      } else {
        imgEl.style.display = "none";
        imgEl.src = "";
      }

      const altsContainer = document.getElementById('qAlts');
      altsContainer.innerHTML = "";
      
      const keys = q.type === 'essay' ? ["", ""] : ["A","B","C","D","E"];
      
      q.alts.forEach((altText, idx) => {
        let div = document.createElement('div');
        div.className = "alt";
        if(userAnswers[q.id] === idx) div.classList.add("selected");
        
        div.onclick = () => selectAlternative(q.id, idx);
        
        let keyHtml = keys[idx] ? `<span class="key">${keys[idx]})</span>` : ``;
        div.innerHTML = `${keyHtml}<span>${altText}</span>`;
        altsContainer.appendChild(div);
      });

      const btnRev = document.getElementById('btnMarkReview');
      if(reviewMarks.has(q.id)) {
        btnRev.classList.add('active');
        btnRev.textContent = "üö© Marcada (Desmarcar)";
      } else {
        btnRev.classList.remove('active');
        btnRev.textContent = "üö© Marcar Revis√£o";
      }

      updateGridHighlight();
    }

    function selectAlternative(qId, altIdx) {
      if(isPaused) return;
      userAnswers[qId] = altIdx;
      renderQuestion();
      updateGridData();
    }

    function toggleReview() {
      if(isPaused) return;
      const q = examData[currentIdx];
      if(reviewMarks.has(q.id)) reviewMarks.delete(q.id);
      else reviewMarks.add(q.id);
      renderQuestion();
      updateGridData();
    }

    function nav(delta) {
      if(isPaused) return;
      currentIdx += delta;
      if(currentIdx < 0) currentIdx = examData.length - 1;
      if(currentIdx >= examData.length) currentIdx = 0;
      renderQuestion();
    }

    function jumpTo(idx) {
      if(isPaused) return;
      currentIdx = idx;
      renderQuestion();
    }

    /* =========================================================
       GRADE / MAPA DA PROVA (AUTO-SCROLL INCLUSO)
       ========================================================= */
    function buildGrid() {
      const grid = document.getElementById('gridMap');
      grid.innerHTML = "";

      examData.forEach((q, i) => {
        let box = document.createElement('div');
        box.className = 'g-box';
        box.id = `gb-${q.id}`;
        
        if(q.type === 'essay') {
          box.classList.add('g-box-redacao');
          box.textContent = "‚úçÔ∏è Reda√ß√£o";
        } else {
          box.textContent = i + 1;
        }

        box.onclick = () => jumpTo(i);
        grid.appendChild(box);
      });
      updateGridData();
    }

    function updateGridData() {
      examData.forEach(q => {
        let box = document.getElementById(`gb-${q.id}`);
        if(!box) return;
        box.classList.remove('answered', 'review');
        
        if(userAnswers[q.id] !== undefined) box.classList.add('answered');
        if(reviewMarks.has(q.id)) box.classList.add('review');
      });
    }

    function updateGridHighlight() {
      document.querySelectorAll('.g-box').forEach(b => b.classList.remove('current'));
      let currId = examData[currentIdx].id;
      let box = document.getElementById(`gb-${currId}`);
      if(box) {
        box.classList.add('current');
        
        // ROLAGEM AUTOM√ÅTICA NO MOBILE
        if (window.innerWidth <= 800) {
          box.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
      }
    }

    /* =========================================================
       RELAT√ìRIO FINAL DETALHADO
       ========================================================= */
    function finishExam(force = false) {
      if(!force) {
        let answeredCount = Object.keys(userAnswers).length;
        if(!confirm(`Voc√™ respondeu ${answeredCount} de ${examData.length} quest√µes. Deseja mesmo entregar a prova?`)) return;
      }
      clearInterval(timerInterval);
      generateReport();
      showScreen('screenReport');
    }

    function generateReport() {
      let hits = 0;
      let misses = 0;
      let blanks = 0;
      let redacaoStatus = "N√£o realizada";
      let isRedacaoDone = false;

      const rGrid = document.getElementById('rGrid');
      rGrid.innerHTML = "";
      
      const letters = ['A', 'B', 'C', 'D', 'E'];
      let detailsHtml = '<h3 style="margin-top:20px; margin-bottom:15px; text-align:center; color: var(--txt-muted);">Detalhamento de Erros e Em Branco</h3>';
      let hasErrorsOrBlanks = false;

      examData.forEach((q, i) => {
        if(q.type === 'essay') {
          if(userAnswers[q.id] === 0) { 
            redacaoStatus = "Conclu√≠da";
            isRedacaoDone = true;
          }
          return; 
        }

        let box = document.createElement('div');
        box.className = 'rg-box';
        box.textContent = i + 1;

        let userAns = userAnswers[q.id];
        let isBlank = userAns === undefined;
        let isHit = userAns === q.answer;

        if(isBlank) {
          blanks++;
          box.classList.add('blank');
          hasErrorsOrBlanks = true;
          detailsHtml += `
            <div class="r-detail-item blank">
              <div class="r-detail-title">Quest√£o ${i + 1} (${q.mat})</div>
              <div class="r-detail-ans">Sua resposta: <b>N√£o respondeu</b> | Gabarito Correto: <b class="correct">${letters[q.answer]}</b></div>
            </div>`;
        } else if (isHit) {
          hits++;
          box.classList.add('hit');
        } else {
          misses++;
          box.classList.add('miss');
          hasErrorsOrBlanks = true;
          detailsHtml += `
            <div class="r-detail-item miss">
              <div class="r-detail-title">Quest√£o ${i + 1} (${q.mat})</div>
              <div class="r-detail-ans">Sua marca√ß√£o: <b class="wrong">${letters[userAns]}</b> | Gabarito Correto: <b class="correct">${letters[q.answer]}</b></div>
            </div>`;
        }
        rGrid.appendChild(box);
      });

      if(hasErrorsOrBlanks) {
          document.getElementById('rDetails').innerHTML = detailsHtml;
      } else {
          document.getElementById('rDetails').innerHTML = '<h3 style="margin-top:20px; text-align:center; color: var(--good);">üéâ Perfeito! Nenhum erro cometido.</h3>';
      }

      let totalObj = hits + misses;
      let acc = totalObj > 0 ? Math.round((hits / totalObj) * 100) : 0;

      let hFormat = Math.floor(elapsedSeconds / 3600).toString().padStart(2, '0');
      let mFormat = Math.floor((elapsedSeconds % 3600) / 60).toString().padStart(2, '0');
      document.getElementById('rSubtitle').textContent = `Prova: ${currentExamType} ‚Ä¢ Tempo Gasto: ${hFormat}:${mFormat} ‚Ä¢ Em Branco: ${blanks}`;
      
      document.getElementById('rHits').textContent = hits;
      document.getElementById('rMisses').textContent = misses;
      document.getElementById('rAcc').textContent = acc + "%";

      const redNode = document.getElementById('rRedacaoStatus');
      if(currentExamType === 'D1') {
        redNode.style.display = "block";
        redNode.textContent = `Reda√ß√£o: ${redacaoStatus}`;
        if(isRedacaoDone) redNode.classList.add('feito');
        else redNode.classList.remove('feito');
      } else {
        redNode.style.display = "none";
      }
    }

    /* =========================================================
       EXPORTA√á√ÉO DE IMAGEM
       ========================================================= */
    async function exportReport() {
      const node = document.getElementById('reportNode');
      try {
        await new Promise(r => setTimeout(r, 100));
        const canvas = await html2canvas(node, { backgroundColor: '#f1f3f5', scale: 2 });
        const dataUrl = canvas.toDataURL("image/png");
        
        document.getElementById('exportedImage').src = dataUrl;
        document.getElementById('exportModal').classList.add('active');
      } catch (e) {
        alert("Erro ao gerar imagem.");
      }
    }
  </script>
</body>
</html>
